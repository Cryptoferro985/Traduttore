<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Traduzione Semplice</title>
    <style>
        :root { --primary: #4f46e5; --bg: #f1f5f9; --card: #ffffff; --accent: #10b981; --error: #ef4444; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { width: 92%; max-width: 400px; background: var(--card); padding: 25px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
        .box { text-align: left; background: #f8fafc; padding: 20px; border-radius: 20px; margin-bottom: 15px; border: 1px solid #e2e8f0; position: relative; }
        .label { font-size: 11px; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; }
        #txt-fonetica { font-size: 26px; font-weight: 800; color: var(--primary); margin: 10px 0; line-height: 1.2; }
        #txt-thai { font-size: 15px; color: #64748b; font-weight: 500; }
        .btn { border: none; padding: 18px; border-radius: 16px; font-size: 16px; font-weight: 700; cursor: pointer; width: 100%; margin-bottom: 12px; transition: all 0.2s; }
        #btn-ita { background: var(--accent); color: white; }
        #btn-eser { background: var(--primary); color: white; display: none; }
        .audio-btn { position: absolute; right: 15px; top: 35%; background: white; border: 1px solid #e2e8f0; border-radius: 50%; width: 42px; height: 42px; display: none; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

<div class="container">
    <h1 id="status" style="font-size: 16px; color: #475569; margin-bottom: 20px;">Traduzione Semplice</h1>
    
    <select id="sel-lang" style="width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 20px; font-size: 15px;">
        <option value="th-TH">ðŸ‡¹ðŸ‡­ Thailandese</option>
        <option value="en-US">ðŸ‡ºðŸ‡¸ Inglese</option>
    </select>

    <div class="box">
        <div class="label">Pronuncia (Fonetica)</div>
        <div id="txt-fonetica">---</div>
        <div id="txt-thai">---</div>
        <button id="btn-audio" class="audio-btn" onclick="riproduciVoce()">ðŸ”Š</button>
    </div>

    <button id="btn-ita" class="btn" onclick="startIta()">PARLA IN ITALIANO</button>
    <button id="btn-eser" class="btn" onclick="startEser()">ESERCITAZIONE</button>
</div>

<script>
    let rec = null;
    let traduzioneSalvata = "";

    function parla(testo, lingua) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(testo);
        u.lang = lingua;
        u.rate = 0.8;
        window.speechSynthesis.speak(u);
    }

    function riproduciVoce() {
        if (traduzioneSalvata) parla(traduzioneSalvata, document.getElementById('sel-lang').value);
    }

    async function traduci(testoIn) {
        const target = document.getElementById('sel-lang').value.split('-')[0];
        try {
            const r = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=it&tl=${target}&dt=t&dt=rm&q=${encodeURIComponent(testoIn)}`);
            const d = await r.json();
            
            traduzioneSalvata = d[0][0][0];
            let fonetica = (d[0][1] && d[0][1][3]) ? d[0][1][3] : (d[0][0][3] || traduzioneSalvata);
            // Pulisce la fonetica da accenti strani per renderla leggibile
            fonetica = fonetica.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

            document.getElementById('txt-fonetica').innerText = fonetica;
            document.getElementById('txt-thai').innerText = traduzioneSalvata;
            document.getElementById('btn-eser').style.display = "block";
            document.getElementById('btn-audio').style.display = "flex";
            
            parla(traduzioneSalvata, document.getElementById('sel-lang').value);
        } catch (e) { alert("Errore connessione"); }
    }

    function startIta() {
        if (rec) rec.stop();
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        rec = new Speech();
        rec.lang = "it-IT";
        
        rec.onstart = () => { document.getElementById('status').innerText = "ðŸ”´ ASCOLTO ITALIANO..."; };
        rec.onresult = (e) => { 
            const risultato = e.results[0][0].transcript;
            traduci(risultato);
        };
        rec.onend = () => { document.getElementById('status').innerText = "Traduzione Semplice"; };
        rec.start();
    }

    function startEser() {
        if (rec) rec.stop();
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        rec = new Speech();
        rec.lang = document.getElementById('sel-lang').value;

        rec.onstart = () => { document.getElementById('status').innerText = "ðŸ”µ RIPETI ORA..."; };
        rec.onresult = (e) => {
            const detto = e.results[0][0].transcript.toLowerCase();
            const atteso = traduzioneSalvata.toLowerCase();
            
            if (detto.includes(atteso) || atteso.includes(detto) || detto.length > 2) {
                document.getElementById('txt-fonetica').innerText = "ECCELLENTE!";
                document.getElementById('txt-fonetica').style.color = "var(--accent)";
                parla("Bravo, pronuncia corretta", "it-IT");
            } else {
                document.getElementById('txt-fonetica').innerText = "RIPROVA";
                document.getElementById('txt-fonetica').style.color = "var(--error)";
                parla("Non Ã¨ corretto, riprova", "it-IT");
            }
        };
        rec.onend = () => { 
            setTimeout(() => { document.getElementById('txt-fonetica').style.color = "var(--primary)"; }, 2000);
        };
        rec.start();
    }
</script>
</body>
</html>
